<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºç£æ•™è©å½™æ›¿æ›å·¥å…· - V1.3.0</title>
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-hover: #4338ca;
            --success-color: #059669; /* Emerald 600 */
            --success-hover: #047857;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --highlight-bg: #fef08a;
            --highlight-text: #854d0e;
        }

        body.dark-mode {
            --primary-color: #6366f1;
            --primary-hover: #818cf8;
            --success-color: #10b981;
            --success-hover: #34d399;
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-main: #f9fafb;
            --text-sub: #9ca3af;
            --border-color: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --highlight-bg: #854d0e;
            --highlight-text: #fefce8;
        }

        /* åŸºç¤è¨­å®š */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* è®“å…§å®¹å¾ä¸Šæ–¹é–‹å§‹ï¼Œä¸è¦å‚ç›´ç½®ä¸­ */
            transition: background-color 0.3s, color 0.3s;
        }

        /* ä¸»å®¹å™¨å¡ç‰‡ */
        .container {
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 1200px;
            padding: 30px;
            box-sizing: border-box;
            margin-top: 20px;
        }

        /* Header å€åŸŸ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h1 span.badge {
            font-size: 0.8rem;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        /* æ·±è‰²æ¨¡å¼æŒ‰éˆ• */
        #darkModeToggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        #darkModeToggle:hover {
            background-color: var(--bg-color);
        }

        /* ç·¨è¼¯å€åŸŸ Grid */
        .editor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .editor-grid {
                grid-template-columns: 1fr;
            }
        }

        .editor-col {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-sub);
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        textarea, #highlightDiv {
            width: 100%;
            height: 450px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Consolas', 'Monaco', monospace; /* ç­‰å¯¬å­—é«”æ–¹ä¾¿å°é½Šå­—å¹• */
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        /* é«˜äº®å±¤ */
        #highlightDiv {
            display: none;
            overflow-y: auto;
            white-space: pre-wrap;
            border-color: var(--success-color); /* å€åˆ†é€™æ˜¯é è¦½æ¨¡å¼ */
        }

        .highlight-tag {
            background-color: var(--highlight-bg);
            color: var(--highlight-text);
            padding: 0 4px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* è¦–åœ–åˆ‡æ›æŒ‰éˆ• (Badge Style) */
        .view-toggle {
            font-size: 0.8rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-sub);
            padding: 4px 10px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .view-toggle:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .view-toggle.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* æ“ä½œå€ (Action Bar) */
        .action-bar {
            background-color: var(--bg-color);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: space-between;
            align-items: center;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        button.btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button.btn:active {
            transform: scale(0.98);
        }

        button.btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        button.btn-primary:hover {
            background-color: var(--primary-hover);
        }

        button.btn-secondary {
            background-color: white;
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }
        body.dark-mode button.btn-secondary {
            background-color: #374151;
            border-color: #4b5563;
        }
        button.btn-secondary:hover {
            background-color: var(--bg-color);
        }

        button.btn-ai {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
        }
        button.btn-ai:hover {
            opacity: 0.9;
            box-shadow: 0 6px 8px rgba(16, 185, 129, 0.3);
        }

        /* çµæœç‹€æ…‹åˆ— */
        .status-bar {
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--text-sub);
            padding: 10px;
            border-top: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
        }
        
        .status-highlight {
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Toast é€šçŸ¥æ¨£å¼ (åº•éƒ¨æµ®å‹•) */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px); /* åˆå§‹éš±è— */
            background-color: #323232;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            font-size: 0.95rem;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            background-color: #ef4444;
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>åŸºç£æ•™è©å½™æ›¿æ›å·¥å…· <span class="badge">V1.3</span></h1>
        <button id="darkModeToggle">ğŸŒ“ åˆ‡æ›æ¨¡å¼</button>
    </header>

    <div class="editor-grid">
        <div class="editor-col">
            <div class="label-row">
                <label for="inputText">ğŸ“¥ åŸå§‹å­—å¹• (SRT)</label>
            </div>
            <textarea id="inputText" placeholder="è«‹å°‡åŸå§‹ .srt å…§å®¹è²¼åœ¨é€™è£¡..."></textarea>
        </div>

        <div class="editor-col">
            <div class="label-row">
                <label for="outputText">ğŸ“¤ è™•ç†çµæœ</label>
                <button id="toggleViewBtn" class="view-toggle">ğŸ‘ï¸ é è¦½é«˜äº®å·®ç•°</button>
            </div>
            <textarea id="outputText" placeholder="è™•ç†å¾Œçš„çµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼Œä½ å¯ä»¥ç›´æ¥ç·¨è¼¯..."></textarea>
            <div id="highlightDiv"></div>
        </div>
    </div>

    <div class="action-bar">
        <div class="btn-group">
            <button id="convertButton" class="btn btn-secondary">ğŸ” ç°¡è½‰ç¹</button>
            <button id="replaceButton" class="btn btn-primary">ğŸš€ åŸ·è¡Œæ›¿æ› & å¤§å¯«</button>
            <button id="removeTimecodesButton" class="btn btn-secondary">âŒ åˆªé™¤æ™‚é–“ç¢¼</button>
        </div>
        
        <div class="btn-group">
            <button id="copyButton" class="btn btn-secondary">ğŸ“‹ å…¨é¸è¤‡è£½</button>
            <button id="aiPromptButton" class="btn btn-ai">âœ¨ è¤‡è£½ AI æ ¡å°æŒ‡ä»¤</button>
        </div>
    </div>

    <div class="status-bar">
        <span id="replaceResult">ç­‰å¾…è™•ç†...</span>
        <span id="replaceCount" class="status-highlight"></span>
    </div>
</div>

<div id="toast" class="toast">è¨Šæ¯æç¤º</div>

<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/cn2t.js"></script>

<script>
    // ==========================================
    //  é‚è¼¯æ ¸å¿ƒ (ä¿ç•™åŸæœ¬çš„ JS åŠŸèƒ½ï¼Œåƒ…ä¿®æ”¹ UI äº’å‹•)
    // ==========================================

    var dataUrl = 'https://raw.githubusercontent.com/Enoooch0921/Srt-Christian-vocabulary-replacement/main/keywords.csv';
    var globalKeywords = {}; 

    // HTML è½‰ç¾©
    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // é¡¯ç¤º Toast é€šçŸ¥çš„å‡½æ•¸ (æ–°ç‰ˆ)
    function showToast(message, type = 'normal') {
        var toast = document.getElementById('toast');
        toast.innerText = message;
        toast.className = 'toast show'; // é‡ç½® class
        
        if (type === 'error') {
            toast.classList.add('error');
        }

        setTimeout(function() {
            toast.classList.remove('show');
        }, 3000);
    }

    // å…¼å®¹èˆŠç‰ˆå‡½æ•¸åï¼Œå°å‘æ–°çš„ Toast
    function showMessage(msg) { showToast(msg); }
    function showError(msg) { showToast(msg, 'error'); }
    function showCopyMessage(msg) { showToast(msg); }

    function loadData(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                callback(xhr.responseText);
            }
        };
        xhr.open('GET', url, true);
        xhr.send();
    }

    RegExp.escape = function(s) {
        return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    };

    function capitalizeWords(text) {
        return text.replace(/\b\w/g, function(match) { return match.toUpperCase(); });
    }

    // æ ¸å¿ƒæ›¿æ›é‚è¼¯
    function replaceText(keywords) {
        var rawInput = document.getElementById('inputText').value;
        if(!rawInput.trim()) {
            showError("è«‹å…ˆè¼¸å…¥å…§å®¹ï¼");
            return;
        }

        var plainText = rawInput;
        var htmlText = escapeHtml(rawInput); 
        
        var count = 0;
        var logText = "å·²å®Œæˆä»¥ä¸‹æ›¿æ›ï¼š ";

        for (var key in keywords) {
            var regExp = new RegExp(RegExp.escape(key), 'gi');
            
            // 1. ç´”æ–‡æœ¬è™•ç†
            if (typeof keywords[key] === 'object') {
                var [replacement, context] = keywords[key];
                var matches = plainText.match(regExp);
                if (matches) {
                    var lines = plainText.split('\n');
                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].match(regExp)) {
                            var start = Math.max(0, i - 1);
                            var end = Math.min(lines.length - 1, i + 1);
                            var contextMatch = context.some(function(ctxWord) {
                                for (var j = start; j <= end; j++) {
                                    if (lines[j].includes(ctxWord)) return true;
                                }
                                return false;
                            });
                            if (contextMatch) {
                                lines[i] = lines[i].replace(regExp, replacement);
                                count++;
                            }
                        }
                    }
                    plainText = lines.join('\n');
                }
            } else {
                var replacement = keywords[key];
                var matches = plainText.match(regExp);
                if (matches) {
                    count += matches.length;
                    plainText = plainText.replace(regExp, replacement);
                }
            }

            // 2. HTML é«˜äº®è™•ç† (ç°¡åŒ–ç‰ˆï¼šåªæ¨™è¨˜ä½ç½®)
            var target = (typeof keywords[key] === 'object') ? keywords[key][0] : keywords[key];
            htmlText = htmlText.replace(regExp, function(match) {
                return '<span class="highlight-tag">' + target + '</span>';
            });
        }

        plainText = capitalizeWords(plainText);
        
        document.getElementById('outputText').value = plainText;
        document.getElementById('highlightDiv').innerHTML = htmlText;
        
        // æ›´æ–°ç‹€æ…‹åˆ—
        document.getElementById('replaceResult').innerText = "âœ… è™•ç†å®Œæˆï¼";
        document.getElementById('replaceCount').innerText = "å…±æ›¿æ› " + count + " å€‹è©å½™";
        
        if(isHighlightMode) {
             document.getElementById('highlightDiv').style.display = 'block';
             document.getElementById('outputText').style.display = 'none';
        }
        
        showToast("æ›¿æ›å®Œæˆï¼å…± " + count + " è™•ä¿®æ”¹");
    }

    // è¦–åœ–åˆ‡æ›
    var isHighlightMode = false;
    document.getElementById('toggleViewBtn').addEventListener('click', function() {
        var txtArea = document.getElementById('outputText');
        var hlDiv = document.getElementById('highlightDiv');
        var btn = document.getElementById('toggleViewBtn');

        if (!isHighlightMode) {
            if(hlDiv.innerHTML === "") hlDiv.innerHTML = escapeHtml(txtArea.value);
            txtArea.style.display = 'none';
            hlDiv.style.display = 'block';
            btn.classList.add('active');
            btn.innerText = "âœï¸ è¿”å›ç·¨è¼¯æ¨¡å¼";
        } else {
            txtArea.style.display = 'block';
            hlDiv.style.display = 'none';
            btn.classList.remove('active');
            btn.innerText = "ğŸ‘ï¸ é è¦½é«˜äº®å·®ç•°";
        }
        isHighlightMode = !isHighlightMode;
    });

    // åˆªé™¤æ™‚é–“ç¢¼
    function removeTimecode() {
        var outputText = document.getElementById('outputText').value;
        if(!outputText) { showError("æ²’æœ‰å…§å®¹å¯ä»¥è™•ç†"); return; }
        
        var lines = outputText.split('\n');
        var newText = [];
        var timecodePattern = /^\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3}$/;
        var hasTimecodes = false;

        for (var i = 0; i < lines.length; i++) {
            if (timecodePattern.test(lines[i])) {
                hasTimecodes = true;
                if (i + 1 < lines.length && lines[i + 1].trim() !== '') {
                    newText.push(lines[i + 1]);
                }
            }
        }

        if (hasTimecodes) {
            var result = newText.join('\n').trim();
            document.getElementById('outputText').value = result;
            document.getElementById('highlightDiv').innerText = result; // é‡ç½®é«˜äº®
            showToast("âœ… æ™‚é–“ç¢¼å·²åˆªé™¤");
        } else {
            showError('æ‰¾ä¸åˆ°æ™‚é–“ç¢¼æ ¼å¼');
        }
    }

    function selectAndCopy() {
        var outputText = document.getElementById('outputText');
        if(isHighlightMode) document.getElementById('toggleViewBtn').click();
        
        if(!outputText.value) { showError("æ²’æœ‰å…§å®¹å¯ä»¥è¤‡è£½"); return; }

        outputText.select();
        document.execCommand('copy');
        showToast('ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    }

    function parseCsvData(csvData) {
        var lines = csvData.split('\n');
        var keywords = {};
        lines.forEach(function(line) {
            var parts = line.split(',');
            if (parts.length >= 2) {
                if (parts.length === 3) {
                    keywords[parts[0].trim()] = [parts[1].trim(), parts[2].trim().split('|')];
                } else {
                    keywords[parts[0].trim()] = parts[1].trim();
                }
            }
        });
        globalKeywords = keywords;
        return keywords;
    }

    // åˆå§‹åŒ–èˆ‡ç¶å®š
    loadData(dataUrl, function(csvData) {
        var keywords = parseCsvData(csvData);
        document.getElementById('replaceButton').onclick = function() {
            replaceText(keywords);
        };
    });

    document.getElementById('copyButton').onclick = selectAndCopy;
    document.getElementById('removeTimecodesButton').onclick = removeTimecode;

    // eslint-disable-next-line
    const converter = OpenCC.Converter({ from: "cn", to: "tw" });
    document.getElementById('convertButton').addEventListener('click', function() {
        var inputText = document.getElementById('inputText').value;
        if(!inputText) { showError("è«‹å…ˆè¼¸å…¥ç°¡é«”å…§å®¹"); return; }
        
        var convertedText = converter(inputText);
        document.getElementById('inputText').value = convertedText;
        showToast('ğŸ” ç¹é«”è½‰æ›æˆåŠŸï¼');
    });

    document.getElementById('darkModeToggle').addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
    });

    // AI Prompt ç”Ÿæˆ
    document.getElementById('aiPromptButton').addEventListener('click', function() {
        var outputText = document.getElementById('outputText').value;
        if (!outputText) { showError('è¼¸å‡ºæ¡†æ²’æœ‰å…§å®¹ï¼Œç„¡æ³•ç”ŸæˆæŒ‡ä»¤'); return; }
        
        var prompt = `è«‹å¹«æˆ‘æ ¡å°ä»¥ä¸‹çš„ SRT å­—å¹•ã€‚

**å‰ç½®èªªæ˜ï¼š**
é€™ä»½å­—å¹•å·²ç¶“ç¶“éã€ŒåŸºç£æ•™è¡“èªã€çš„è‡ªå‹•æ›¿æ›ç¨‹å¼è™•ç†ã€‚

**ä½ çš„ä»»å‹™è¦æ±‚ï¼š**
1. ã€çµ•å°ç¦æ­¢ã€‘ä¿®æ”¹æ™‚é–“ç¢¼ï¼ˆTimecodeï¼‰å’Œåºè™Ÿã€‚
2. ã€æª¢æŸ¥éŒ¯åˆ¥å­—ã€‘ä¿®æ­£å‰©é¤˜çš„åŒéŸ³ç•°å­—ï¼ˆå¦‚ï¼šæœŸç›¼/æ——ç•”ï¼‰ï¼Œä½†è«‹ä¸è¦æ”¹å‹•å·²ç¶“æ­£ç¢ºçš„è–ç¶“å°ˆæœ‰åè©ã€‚
3. ã€èªå¥ä¿®é£¾ã€‘åœ¨ä¸æ”¹è®ŠåŸæ„çš„å‰æä¸‹ï¼Œè®“èªå¥æ›´é€šé †ã€‚
4. ã€è¼¸å‡ºæ ¼å¼ã€‘è«‹å…ˆçµ¦æˆ‘ä¿®æ”¹å¾Œçš„å®Œæ•´ SRT å…§å®¹ï¼Œæœ€å¾Œåˆ—å‡ºä½ ä¿®æ”¹äº†å“ªäº›åœ°æ–¹çš„å°ç…§è¡¨ã€‚

**SRT å…§å®¹å¦‚ä¸‹ï¼š**
${outputText}`;

        navigator.clipboard.writeText(prompt).then(function() {
            showToast('âœ¨ å·²è¤‡è£½ AI æŒ‡ä»¤ï¼è«‹è²¼çµ¦ Gemini');
        }, function() {
            showError('è¤‡è£½å¤±æ•—');
        });
    });

</script>
</body>
</html>
